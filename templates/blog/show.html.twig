{% extends 'base.html.twig' %} 

{% block title %}{{ blog.title }}{% endblock %}

{% block body %}
<section class="blog_single section_padding" style="background-color: #f8f9fa; padding: 60px 0;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                
                <!-- Blog Image -->
                <div class="mb-4">
                    {% if blog.content %}
                        <img src="{{ blog.content }}" alt="{{ blog.title }}" 
                             class="img-fluid rounded" 
                             style="width: 100%; height: 400px; object-fit: cover; border-radius: 10px;">
                    {% else %}
                        <div style="background-color: #e9ecef; height: 400px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <span style="color: #000000; font-size: 1.2rem;">No Image Available</span>
                        </div>
                    {% endif %}
                </div>

                <!-- Blog Title -->
                <h1 class="mb-3" style="color: #000000;">{{ blog.title }}</h1>

                <!-- Flash Messages -->
                {% for message in app.flashes('success') %}
                    <div class="alert alert-success mb-3" style="background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 6px; padding: 10px;">
                        {{ message }}
                    </div>
                {% endfor %}
                
                {% for message in app.flashes('error') %}
                    <div class="alert alert-danger mb-3" style="background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 6px; padding: 10px;">
                        {{ message }}
                    </div>
                {% endfor %}

                <!-- ======================= 1. CATEGORY ======================= -->
                <div class="d-flex align-items-center mb-4" style="color: #000000;">
                    {% if blog.category %}
                        <span style="background-color: #e9ecef; padding: 5px 15px; border-radius: 20px; font-weight: 600; margin-right: 15px; color: #000000;">
                            {{ blog.category }}
                        </span>
                    {% endif %}
                    <span style="color: #000000;">Published on {{ blog.createdAt|date('F d, Y') }}</span>
                </div>

                <!-- ======================= 2. COMMENTS SECTION ======================= -->
                <div class="comments-section mt-5 pt-4" style="border-top: 1px solid #dee2e6;">
                    <h4 class="mb-4" style="color: #000000;">
                        Comments 
                        <span style="background-color: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.9rem;">
                            {{ blog.comments|length }}
                        </span>
                    </h4>

                    {% if blog.comments|length > 0 %}
                        <div class="comments-list">
                            {% for comment in blog.comments %}
                                <div class="mb-4 p-3" style="background-color: white; border-radius: 8px; border-left: 4px solid #007bff;">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <strong style="color: #000000;">{{ comment.user.nom }}</strong>
                                        <small style="color: #000000;">{{ comment.createdAt|date('M d, Y ¬∑ h:i A') }}</small>
                                    </div>
                                    <p style="color: #000000;">{{ comment.content }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4" style="color: #000000;">
                            <p style="color: #000000;">No comments yet. Be the first to comment!</p>
                        </div>
                    {% endif %}

                    <!-- Comment Form with reCAPTCHA -->
                    {% if app.user %}
                        <div class="mt-4 p-4" style="background-color: white; border-radius: 8px;">
                            <h5 class="mb-3" style="color: #000000;">Add a Comment</h5>
                            
                            <form action="{{ path('app_blog_comment', {'id': blog.id}) }}" method="POST">
                                <div class="mb-3">
                                    <textarea name="content" rows="4" 
                                              class="form-control" 
                                              placeholder="Write your comment here..."
                                              style="border: 1px solid #ced4da; border-radius: 6px; padding: 15px; color: #000000;"
                                              required></textarea>
                                </div>
                                
                                <!-- üîê reCAPTCHA Widget -->
                                <div class="mb-3">
                                    <div class="g-recaptcha" data-sitekey="{{ app.request.server.get('EWZ_RECAPTCHA_SITE_KEY') | default('6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI') }}"></div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Submit Comment</button>
                            </form>
                        </div>
                    {% else %}
                        <div class="mt-4 p-3 text-center" style="background-color: #e9ecef; border-radius: 8px;">
                            <p class="mb-0" style="color: #000000;">
                                Please <a href="{{ path('app_login') }}" style="color: #007bff;">log in</a> to add a comment.
                            </p>
                        </div>
                    {% endif %}
                </div>

                <!-- ======================= 3. RATING SYSTEM ======================= -->
                <div class="mb-4 mt-5 pt-4" style="background-color: white; padding: 15px; border-radius: 8px; border-top: 1px solid #dee2e6;">
                    <h4 class="mb-3" style="color: #000000;">Rate this Blog</h4>
                    
                    <div class="d-flex align-items-center">
                        <!-- Rating Form -->
                        <form action="{{ path('app_blog_rate', {'id': blog.id}) }}" method="POST" id="rating-form" style="display: inline;">
                            {% set userRating = app.user ? blog.getUserRating(app.user.id) : 0 %}
                            {% for i in 1..5 %}
                                <button type="submit" name="value" value="{{ i }}" class="star-btn" 
                                        style="background: none; border: none; padding: 0 2px; margin: 0; outline: none;"
                                        {% if not app.user %}disabled{% endif %}>
                                    <span class="star {% if i <= userRating %}filled{% endif %}" 
                                          style="font-size: 28px; {% if not app.user %}cursor: not-allowed; opacity: 0.5;{% endif %}">
                                        ‚òÖ
                                    </span>
                                </button>
                            {% endfor %}
                        </form>

                        <span id="rating-average" style="margin-left: 15px; font-weight: 600; color: #000000;">
                            {{ blog.getAverageRating() }}/5
                        </span>

                        <span id="rating-count" style="margin-left: 10px; color: #000000;">
                            ({{ blog.getRatingCount() }} vote{{ blog.getRatingCount() > 1 ? 's' : '' }})
                        </span>
                    </div>

                    {% if not app.user %}
                        <div class="mt-2">
                            <small style="color: #6c757d;">
                                <a href="{{ path('app_login') }}" style="color: #007bff;">Log in</a> to rate this blog
                            </small>
                        </div>
                    {% endif %}
                    
                    <!-- Rating Distribution Stats -->
                    {% if blog.getRatingCount() > 0 %}
                        <div class="rating-stats mt-3 pt-3" style="border-top: 1px solid #e9ecef;">
                            <small style="color: #6c757d;">Rating distribution:</small>
                            {% set distribution = blog.getRatingDistribution() %}
                            {% for stars in 1..5 %}
                                <div class="d-flex align-items-center mt-1">
                                    <span style="width: 30px; color: #000000;">{{ stars }}‚òÖ</span>
                                    <div style="flex: 1; height: 8px; background-color: #e9ecef; border-radius: 4px; margin: 0 10px;">
                                        {% set percentage = blog.getRatingCount() > 0 ? (distribution[stars] / blog.getRatingCount() * 100) : 0 %}
                                        <div style="width: {{ percentage }}%; height: 100%; background-color: #ffc107; border-radius: 4px;"></div>
                                    </div>
                                    <span style="color: #000000;">{{ distribution[stars] }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

            </div>
        </div>
    </div>
</section>

<!-- üîê Script reCAPTCHA Google -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<style>
/* ‚≠ê Rating Stars CSS */
.star-btn {
    background: none;
    border: none;
    padding: 0 2px;
    margin: 0;
    cursor: pointer;
    transition: transform 0.2s;
}

.star-btn:hover:not(:disabled) {
    transform: scale(1.2);
}

.star-btn:disabled {
    cursor: not-allowed;
    opacity: 0.5;
}

.star {
    font-size: 28px;
    color: #ccc;
    transition: color 0.2s;
    display: inline-block;
}

.star.filled {
    color: #ffc107;
}

.star-btn:hover:not(:disabled) .star {
    color: #ffdd55;
}

/* Comments & buttons */
.comments-list div:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
    padding: 10px 30px;
    border-radius: 6px;
    color: #ffffff;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s;
}

.btn-primary:hover {
    background-color: #0056b3;
}

/* Alert messages */
.alert {
    padding: 12px 20px;
    border-radius: 6px;
    margin-bottom: 15px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.rating-stats {
    font-size: 0.9rem;
}

/* Style pour le widget reCAPTCHA */
.g-recaptcha {
    margin: 15px 0;
    transform: scale(1);
    transform-origin: 0 0;
}

/* Responsive pour mobile */
@media (max-width: 480px) {
    .g-recaptcha {
        transform: scale(0.8);
        transform-origin: 0 0;
    }
}
</style>

<script>
// Simple hover effect for stars
document.addEventListener('DOMContentLoaded', function() {
    const starButtons = document.querySelectorAll('.star-btn');
    
    starButtons.forEach(button => {
        button.addEventListener('mouseenter', function() {
            if (this.disabled) return;
            
            const value = parseInt(this.value);
            const stars = document.querySelectorAll('.star-btn');
            
            stars.forEach((btn, index) => {
                const star = btn.querySelector('.star');
                if (index < value) {
                    star.style.color = '#ffdd55';
                } else {
                    // Restore original color based on filled state
                    if (star.classList.contains('filled')) {
                        star.style.color = '#ffc107';
                    } else {
                        star.style.color = '#ccc';
                    }
                }
            });
        });
        
        button.addEventListener('mouseleave', function() {
            if (this.disabled) return;
            
            const stars = document.querySelectorAll('.star-btn');
            stars.forEach(btn => {
                const star = btn.querySelector('.star');
                if (star.classList.contains('filled')) {
                    star.style.color = '#ffc107';
                } else {
                    star.style.color = '#ccc';
                }
            });
        });
    });

    // Auto-hide alerts after 5 seconds
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            alert.style.transition = 'opacity 0.5s';
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 500);
        }, 5000);
    });
});
</script>

{% endblock %}