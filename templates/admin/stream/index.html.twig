{% extends 'admin/dashboard.html.twig' %}

{% block title %}Live Streaming{% endblock %}

{% block admin_content %}

<div class="page-header">
    <h1 class="page-title"><i class="fas fa-video me-2"></i> Live Stream</h1>
    <p class="page-subtitle">Diffusion du flux OBS en direct</p>
</div>

<div class="card mb-4">
    <div class="card-body">
        <h5>Flux Live OBS</h5>

        {% if stream.isActive %}
            <video id="video" controls autoplay muted width="100%" class="rounded" style="background:black;"></video>
            <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
            <script>
            document.addEventListener('DOMContentLoaded', function () {
                var video = document.getElementById('video');
                var videoSrc = "{{ streamUrl }}?t=" + new Date().getTime();

                if (Hls.isSupported()) {
                    var hls = new Hls({ maxRetry: 6, retryDelay: 1000 });
                    hls.loadSource(videoSrc);
                    hls.attachMedia(video);

                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        video.play().catch(e => console.log('Autoplay bloqué :', e));
                    });

                    hls.on(Hls.Events.ERROR, function(event, data) {
                        console.error('Erreur HLS.js :', data);
                        if(data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
                                case Hls.ErrorTypes.MEDIA_ERROR: hls.recoverMediaError(); break;
                                default: console.error('Erreur fatale HLS, arrêt du flux'); break;
                            }
                        }
                    });

                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = videoSrc;
                    video.play().catch(e => console.log('Autoplay bloqué :', e));
                } else {
                    alert("Votre navigateur ne supporte pas HLS.js et ne peut pas lire ce flux.");
                }
            });
            </script>

        {% else %}
            <div class="alert alert-secondary">
                Le flux est actuellement arrêté. Cliquez sur Start pour lancer la diffusion.
            </div>
        {% endif %}

        <div class="mt-3">
            {% if not stream.isActive %}
                <a href="{{ path('admin_stream_start', {'id': stream.id}) }}" class="btn btn-success">Start</a>
            {% endif %}
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h5>Vidéos uploadées</h5>

        {% if videos is not empty %}
            {% for video in videos %}
                <div class="mb-3 position-relative">
                    <video controls width="100%" class="rounded">
                        <source src="{{ video.url }}" type="video/mp4">
                        Votre navigateur ne supporte pas la lecture vidéo.
                    </video>

                   
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-secondary">
                Aucune vidéo uploadée pour le moment.
            </div>
        {% endif %}

        <div class="mt-3">
            <a href="{{ path('admin_stream_upload') }}" class="btn btn-primary">Ajouter une vidéo</a>
        </div>
    </div>
</div>

{% endblock %}